---
title: "Flutterã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†æ¢è¨ªâ‘  PointerEvent"
emoji: "ğŸ‘†"
type: "tech"
topics: ["flutter"]
published: true
published_at: "2022-03-17 23:52"
---

ç§é”ãŒFlutterã‚’æ›¸ã„ã¦ã„ã‚‹ã¨ãã€ä½•æ°—ãªãä½¿ã£ã¦ã„ã‚‹`Button`ã‚„`InkWell`ã€`GestureDetector`ãªã©ã¯è£ã§ã©ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã€€
å®Ÿè£…ã‚’èª­ã¿ãªãŒã‚‰å‡¦ç†ã®æµã‚Œã‚’ãªãã£ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

# ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®æ¦‚è¦

å¤§ã¾ã‹ã«ã¯å…¬å¼ã«ä»¥ä¸‹ã®ã‚ˆã†ãªèª¬æ˜ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

https://docs.flutter.dev/development/ui/advanced/gestures

## 2ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼

Flutterã§ã¯ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«**Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼**ã¨**Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼**ã®2ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åˆ†ã‘ã¦ã„ã¾ã™ã€‚

### 1.Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼

ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰å–å¾—ã—ãŸã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’ã»ã¼ãã®ã¾ã¾Flutterã®ãƒ„ãƒªãƒ¼ã«ä¼ãˆã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚`Listener` Widgetã‚’ä½¿ã†ã¨Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚ã‚‹ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãƒ€ã‚¦ãƒ³ã€ç§»å‹•ã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãªã©ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

*æœ¬è¨˜äº‹ã§ã¯ã“ã¡ã‚‰ã‚’ãªãã£ã¦ã„ãã¾ã™ã€‚*

### 2.Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼

ã“ã¡ã‚‰ã¯Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã€ã‚¿ãƒƒãƒ—ã‚„ãƒ‰ãƒ©ãƒƒã‚°ã€ãƒ”ãƒ³ãƒãªã©ã®è¤‡é›‘ãªã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãŠãªã˜ã¿`GestureDetector`ã«ã‚ˆã‚ŠGestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµæœã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯GestureArena(ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼é—˜æŠ€å ´)ã§æ¤œçŸ¥ã—ãŸã„ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼åŒå£«ã‚’æˆ¦ã‚ã›ã‚‹ã¨ã„ã†é¢ç™½ã„å®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã“ã®è©±ã¯åˆ¥è¨˜äº‹ã«å›ã—ã¾ã™ã€‚

è¿½è¨˜: æ¬¡ã®è¨˜äº‹â†“

https://zenn.dev/fastriver/articles/cb8f5a2a019715

æ¦‚è¦ã¯ä»–ã«æ›¸ã„ã¦ã„ãŸäººãŒã„ã‚‹ã®ã§ãã‚Œã‚’è²¼ã£ã¦ãŠãã¾ã™

https://qiita.com/mjhd/items/8e300238e494d8755b44

# Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è©³ç´°

ã§ã¯Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ã“ã‚Œã‹ã‚‰è¿½ã†ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚

## PointerEventã®æºæ³‰

![](https://storage.googleapis.com/zenn-user-upload/64b55c62deaa-20220317.png)

> https://docs.flutter.dev/resources/architectural-overview ã‚ˆã‚Š

ä¸Šã®å›³ã«ã‚ã‚‹ã‚ˆã†ã«ã€Flutterã¨ã„ã†ã®ã¯Frameworkã€Engineã€Embedderã®3å±¤ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã¨ã„ã†ã®ã¯å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚‚ã®ãªã®ã§ã€
Embedder -> Engine -> Framework
ã¨ã„ã†é †ã§ã‚¤ãƒ™ãƒ³ãƒˆãŒä¼æ¬ã•ã‚Œã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
Frameworkã®ã‚³ãƒ¼ãƒ‰ã¯

https://github.com/flutter/flutter

Engine/Embedderã®ã‚³ãƒ¼ãƒ‰ã¯

https://github.com/flutter/engine

ã‹ã‚‰èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

Embedderã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã‚Šå®Ÿè£…ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€èª­ã¿ã‚„ã™ã„GLFWãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºç”Ÿã‚’æ¢ã™ã¨ã€`flutter_glfw.cc`ã«ä»¥ä¸‹ã®è¨˜è¿°ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚

```cpp
static void GLFWMouseButtonCallback(GLFWwindow* window,
                                    int key,
                                    int action,
                                    int mods) {
  int64_t button;
  if (key == GLFW_MOUSE_BUTTON_LEFT) {
    button = FlutterPointerMouseButtons::kFlutterPointerButtonMousePrimary;
  } else if (key == GLFW_MOUSE_BUTTON_RIGHT) {
    button = FlutterPointerMouseButtons::kFlutterPointerButtonMouseSecondary;
  } else {
    return;
  }

  auto* controller = GetWindowController(window);
  controller->buttons = (action == GLFW_PRESS) ? controller->buttons | button
                                               : controller->buttons & ~button;

  FlutterPointerEvent event = {};
  SetEventPhaseFromCursorButtonState(window, &event, controller->buttons);
  SetEventLocationFromCursorPosition(window, &event);
  SendPointerEventWithData(window, event);
  //...
}
```

https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/platform/glfw/flutter_glfw.cc#L378

ã“ã®`GLFWMouseButtonCallback()`é–¢æ•°ã¯GLFWã®ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚’é€šçŸ¥ã™ã‚‹`glfwSetMouseButtonCallback`ã«åˆ¥ã®å ´æ‰€ã§ç™»éŒ²ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã—ã¦æœ€å¾Œã®æ–¹ã«`SendPointerEventWithData()`ã‚’å‘¼ã³å‡ºã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```cpp
static void SendPointerEventWithData(GLFWwindow* window,
                                     const FlutterPointerEvent& event_data) {
  //...
  FlutterPointerEvent event = event_data;
  //...
  FlutterEngineSendPointerEvent(controller->engine->flutter_engine, &event, 1);
  //...
}
```

https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/platform/glfw/flutter_glfw.cc#L283

PointerEventã‚’å°‘ã—å¼„ã£ã¦ã‹ã‚‰Embedderã®`FlutterEngineSendPointerEvent()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™(ã“ã“ã‹ã‚‰Embedderå…±é€šå‡¦ç†)ã€‚

```cpp
FlutterEngineResult FlutterEngineSendPointerEvent(
    FLUTTER_API_SYMBOL(FlutterEngine) engine,
    const FlutterPointerEvent* pointers,
    size_t events_count) {
  //...
  auto packet = std::make_unique<flutter::PointerDataPacket>(events_count);
  //...
  return reinterpret_cast<flutter::EmbedderEngine*>(engine)
                 ->DispatchPointerDataPacket(std::move(packet))
             ? kSuccess
             : LOG_EMBEDDER_ERROR(kInternalInconsistency,
                                  "Could not dispatch pointer events to the "
                                  "running Flutter application.");
}
```

https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/platform/embedder/embedder.cc#L1737

æœ€å¾Œã«`EmbedderEngine.DispatchPointerDataPacket()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ã¨é•·ã„ã®ã§ã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã ã‘æ›¸ãã¨ã€

[EmbedderEngine.DispatchPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/platform/embedder/embedder_engine.cc#L115)
-> [PlatformView.DispatchPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/common/platform_view.cc#L35)
-> [Shell.OnPlatformViewDispatchPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/common/shell.cc#L949)
-> [Engine.DispatchiPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/common/engine.cc#L403)
-> [DefaultPointerDataDispatcher.DispatchPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/common/pointer_data_dispatcher.cc#L18)
-> [Engine.DoDispatcherPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/shell/common/engine.cc#L485)
-> [RuntimeController.DispatchPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/runtime/runtime_controller.cc#L238)
-> [Window.DispatchPointerDataPacket()](https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/lib/ui/window/window.cc#L22)

ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```cpp
void Window::DispatchPointerDataPacket(const PointerDataPacket& packet) {
  std::shared_ptr<tonic::DartState> dart_state = library_.dart_state().lock();
  if (!dart_state) {
    return;
  }
  tonic::DartState::Scope scope(dart_state);

  const std::vector<uint8_t>& buffer = packet.data();
  Dart_Handle data_handle =
      tonic::DartByteData::Create(buffer.data(), buffer.size());
  if (Dart_IsError(data_handle)) {
    return;
  }
  tonic::LogIfError(tonic::DartInvokeField(
      library_.value(), "_dispatchPointerDataPacket", {data_handle}));
}
```

`Window.DispatchPointerDataPacket()`ã‹ã‚‰DartInvokeã‚’ä½¿ã„Dartã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

å‘¼ã³å‡ºã—å…ˆã¯`ui/hooks.dart`ã«å®Ÿè£…ãŒã‚ã‚Šã¾ã™ã€‚

```dart
@pragma('vm:entry-point')
void _dispatchPointerDataPacket(ByteData packet) {
  PlatformDispatcher.instance._dispatchPointerDataPacket(packet);
}
```

https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/lib/ui/hooks.dart#L93

ã•ã‚‰ã«`PlatformDispatcher`ã®å‘¼ã³å‡ºã—å…ˆã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```dart
  void _dispatchPointerDataPacket(ByteData packet) {
    if (onPointerDataPacket != null) {
      _invoke1<PointerDataPacket>(
        onPointerDataPacket,
        _onPointerDataPacketZone,
        _unpackPointerDataPacket(packet),
      );
    }
  }
```

https://github.com/flutter/engine/blob/7fe613a77bd2ea0d063977d5baa8ead13fa3cf4b/lib/ui/platform_dispatcher.dart#L329

å‘¼ã³å‡ºã—ã¦ã„ã‚‹'PlatformDispatcher.onPointerDataPacket()'ã«ã¯`GestureBinding._handlePointerDataPacket()`ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã“ã§ã‚„ã£ã¨Flutterã®ä¸–ç•Œã«Pointerã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚„ã£ã¦ãã¾ã—ãŸ(PointerDataPacketã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã­)ã€‚é•·ã„é“ã®ã‚Šã§ã—ãŸãŒåŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã—ã¦ã„ã‚‹ã ã‘ãªã®ã§ã€PointerDownã€PointerMoveã€PointerUpãªã©ãŒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§æ¤œçŸ¥ã•ã‚Œã‚‹ãŸã³ã«ã“ã®é–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```dart
mixin GestureBinding on BindingBase implements HitTestable, HitTestDispatcher, HitTestTarget {
  @override
  void initInstances() {
    super.initInstances();
    _instance = this;
    platformDispatcher.onPointerDataPacket = _handlePointerDataPacket;
  }
  
  //...
  
  void _handlePointerDataPacket(ui.PointerDataPacket packet) {
    // We convert pointer data to logical pixels so that e.g. the touch slop can be
    // defined in a device-independent manner.
    _pendingPointerEvents.addAll(PointerEventConverter.expand(packet.data, window.devicePixelRatio));
    if (!locked)
      _flushPointerEventQueue();
  }
```

https://github.com/flutter/flutter/blob/b4040c867b26097903aaf8814c6ee149400557c7/packages/flutter/lib/src/gestures/binding.dart#L261

`GestureBinding`ã®åˆæœŸåŒ–ã®æŒ™å‹•ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

https://zenn.dev/fastriver/articles/65a1b96911c86e

## PointerDataPacketã®å‡¦ç†

ã§ã¯`GestureBinding`ä¸Šã§ã¯å—ã‘å–ã£ãŸ`PointerDataPacket`ã‚’ã©ã®ã‚ˆã†ã«å‡¦ç†ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚

ã‚‚ã†ä¸€åº¦`_handlePointerDataPacket()`ã‚’è¦‹ã‚‹ã¨ã€`PointerEvent`ã¨ã„ã†å‹ã«å¤‰æ›ã—ãŸã‚‚ã®ã‚’ä¸€åº¦ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜ã—ã€ãã®å¾Œ`_flushPointerEventQueue()`ã§1ã¤ãšã¤å‡¦ç†ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```dart
  void _handlePointerDataPacket(ui.PointerDataPacket packet) {
    // We convert pointer data to logical pixels so that e.g. the touch slop can be
    // defined in a device-independent manner.
    _pendingPointerEvents.addAll(PointerEventConverter.expand(packet.data, window.devicePixelRatio));
    if (!locked)
      _flushPointerEventQueue();
  }
  
  void _flushPointerEventQueue() {
    assert(!locked);

    while (_pendingPointerEvents.isNotEmpty)
      handlePointerEvent(_pendingPointerEvents.removeFirst());
  }
```

ã‚ˆã£ã¦å€‹ã€…ã®`PointerEvent`ã¯`GestureBinding.handlePointerEvent()`ã§ã“ã­å›ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ä¸­ã§ã¯`_handlePointerEventImmediately()`ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã­ã€‚

```dart
  void handlePointerEvent(PointerEvent event) {
    assert(!locked);

    if (resamplingEnabled) {
      _resampler.addOrDispatch(event);
      _resampler.sample(samplingOffset, _samplingClock);
      return;
    }

    // Stop resampler if resampling is not enabled. This is a no-op if
    // resampling was never enabled.
    _resampler.stop();
    _handlePointerEventImmediately(event);
  }
```

## PointerEventã¨ã¯

å°‘ã—è„±ç·šã—ã¦ã€ã¾ãšFlutterã§æ‰±ã£ã¦ã„ã‚‹`PointerEvent`ã¨ã„ã†ã‹ãŸã¾ã‚Šã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/48c882b90ced-20220317.png)

https://api.flutter.dev/flutter/gestures/PointerEvent-class.html

`PointerEvent`è‡ªä½“ã¯ç”»é¢ã®ã©ã“ã«æŒ‡ãŒè§¦ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã¨ã„ã†ç‚¹ã®æƒ…å ±ã®ã¿ã‚’æŒã£ã¦ã„ã¾ã™ã€‚ä¸€æ–¹`PointerEvent.pointer`ã«ã¯æ•°å­—ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã„ã¦ã€ä¸Šã®å›³ã®ã‚ˆã†ã«pointerãŒåŒã˜ã‚‚ã®ã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚„é•·æŠ¼ã—ãªã©ã€ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã‹ã‚‰é›¢ã‚Œã‚‹ã¾ã§ã®åŒã˜æŒ‡ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
ã“ã®ãŸã‚è¤‡æ•°ã®æŒ‡ãªã©ã«ã‚ˆã‚‹`PointerEvent`ãŒæ¥ãŸã¨ã—ã¦ã‚‚ã€ã©ã®æŒ‡ãŒã©ã“ã¸ç§»å‹•ã—ãŸã®ã‹ã‚’Flutterå´ãŒæ­£ç¢ºã«æŠŠæ¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ã‘ã§ã™ã€‚

å…ˆç¨‹åˆ†é¡ã—ã¦ã„ãŸUpã€Downã€Moveãªã©ã®åˆ†é¡ã¯ãã‚Œãã‚Œ`PointerEvent`ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ãŒæµã‚Œã¦ãã‚‹ã“ã¨ã§åŒºåˆ¥ã§ãã¾ã™ã€‚

ã¾ãŸã€ä¸Šã®å›³ã§ã‚‚ç¤ºã™ã¨ãŠã‚Šã€`PointerEvent`ã¯Downã—ãŸåœ°ç‚¹ãŒæ¤œçŸ¥ç¯„å›²å†…ã§ã‚ã‚Œã°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ã™ã‚‹ã®ã§ã€Moveã‚„Upã¯ç¯„å›²ã‚’ã¯ã¿å‡ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## HitTestResultã«ã‚ˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†å…ˆã®ç®¡ç†

æˆ»ã£ã¦`PointerEvent`ã‚’å‡¦ç†ã™ã‚‹`GestureBinding._handlePointerEventImmediately()`ã§ã¯ã€pointerã”ã¨ã«`HitTestResult`ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

`HitTestResult`ã¯pointerã®ä½ç½®ã«å­˜åœ¨ã™ã‚‹ç”»é¢ã®è¦ç´ ã‚’å…¨ã¦è¨˜æ†¶ã—ã¦ãŠãã“ã¨ã§ã€pointerã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãã‚Œã‚‰ã®è¦ç´ ã«ä¼ãˆã‚‹å½¹å‰²ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

ä»–ã¯ç„¡è¦–ã™ã‚‹ã¨ã—ã¦ã€`PointerDownEvent`ã‚’å—ã‘å–ã£ãŸå ´åˆã¯åˆè¦‹ã®pointerã§ã‚ã‚‹ãŸã‚ã€`_hitTests`ã¨ã„ã†Mapã«pointerã‚’ã‚­ãƒ¼ã«ã—ã¦`HitTestResult`ã‚’æ–°ã—ãä½œã‚Šã¾ã™ã€‚

```dart
    HitTestResult? hitTestResult;
    if (event is PointerDownEvent || event is PointerSignalEvent || event is PointerHoverEvent) {
      assert(!_hitTests.containsKey(event.pointer));
      hitTestResult = HitTestResult();
      hitTest(hitTestResult, event.position);
      if (event is PointerDownEvent) {
        _hitTests[event.pointer] = hitTestResult;
      }
      //...
    }
```

æ¬¡ã«åˆæœŸåŒ–ã®ãŸã‚`hitTest()`ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã€‚`GestureBinding.hitTest()`ã‚’è¦‹ã‚‹ã¨

```dart
  void hitTest(HitTestResult result, Offset position) {
    result.add(HitTestEntry(this));
  }
```

https://api.flutter.dev/flutter/gestures/GestureBinding/hitTest.html

ã‚ã‚Œï¼Ÿ`GestureBinding`è‡ªèº«ã®ã¿ã‚’è¿½åŠ ã—ã¦çµ‚ã‚ã£ã¦ã„ã¾ã™ã­ã€‚`HitTestResult`ã«ã¯è©²å½“ã™ã‚‹å…¨ã¦ã®è¦ç´ ã‚’è¿½åŠ ã—ã¦ãŠãã¯ãšãªã®ã«...

### (è„±ç·š)mixinã®ç½ 

ã¯ã„ã€å®Ÿã¯ã“ã“ã§mixinã®é­”æ³•ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/89e5f1f361b8-20220317.png)

> https://zenn.dev/fastriver/articles/65a1b96911c86e#widgetsflutterbinding%E3%81%A7%E3%81%AE%E4%BD%BF%E3%82%8F%E3%82%8C%E6%96%B9

å¿˜ã‚ŒãŒã¡ã§ã™ãŒ`GestureBinding`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯`WidgetsFlutterBinding`ã§ã€mixinã¯å›³ã®ä¸Šã‹ã‚‰ä¸‹ã«overrideã™ã‚‹ã‚ˆã†ãªå½¢ã«ãªã‚‹ãŸã‚mixinã®ã©ã“ã‹ã«åŒåã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã¨ãã¡ã‚‰ãŒå„ªå…ˆçš„ã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
æ¢ã—ã¦ã¿ã‚‹ã¨ã€ã‚ã‚Šã¾ã—ãŸã‚ˆã€‚`RendererBinding`ã«

```dart
  void hitTest(HitTestResult result, Offset position) {
    assert(renderView != null);
    assert(result != null);
    assert(position != null);
    renderView.hitTest(result, position: position);
    super.hitTest(result, position);
  }
```

https://api.flutter.dev/flutter/rendering/RendererBinding/hitTest.html

ã“ã¡ã‚‰ã§`renderView.hitTest()`ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¾ãŸsuperå‘¼ã³å‡ºã—ã‚’æŒã£ã¦ã„ã‚‹ãŸã‚ã€`GestureBinding`ã®æ–¹ã‚‚ç¶šã„ã¦å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

### RenderObjectãƒ„ãƒªãƒ¼ã®èµ°æŸ»

è½ã¡ç€ã„ãŸã¨ã“ã‚ã§æ¬¡ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚`RenderView.hitTest()`ã¯

```dart
bool hitTest(HitTestResult result, { required Offset position }) {
  if (child != null)
    child!.hitTest(BoxHitTestResult.wrap(result), position: position);
  result.add(HitTestEntry(this));
  return true;
}
```

https://api.flutter.dev/flutter/rendering/RenderView/hitTest.html

è‡ªèº«ã‚’è¿½åŠ ã—ã¦å­ã®hitTestã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚ã“ã“ã§å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹`RenderBox.hitTest()`ã¯

```dart
bool hitTest(BoxHitTestResult result, { required Offset position }) {
  //...
  if (_size!.contains(position)) {
    if (hitTestChildren(result, position: position) || hitTestSelf(position)) {
      result.add(BoxHitTestEntry(this, position));
      return true;
    }
  }
  return false;
}
```

https://api.flutter.dev/flutter/rendering/RenderBox/hitTest.html

`hitTestChildren()`ã¨`hitTestSelf()`ã®ã©ã¡ã‚‰ã‹ãŒãƒ’ãƒƒãƒˆã™ã‚Œã°è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ã€ã¨ã—ã¦ã„ã¾ã™ã€‚

:::message
`RenderBox`ã¯RenderObjectãƒ„ãƒªãƒ¼ã‚’æ§‹æˆã™ã‚‹ã“ã¨ã®ã§ãã‚‹RenderObjectã®åŸºæœ¬ã®ã‚¯ãƒ©ã‚¹ã«ãªã‚Šã¾ã™
:::

**`hitTestChildren()`** ã§ã¯ã€å­ã‚’æŒã¤å ´åˆã¯å­ã®ä½ç½®ã ã‘åˆ¤å®šã‚’ãšã‚‰ã—ã¦ã‹ã‚‰å­ã®`hitTest()`ã‚’å‘¼ã¶ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã„ãšã‚Œã‹ã®å­ãŒãƒ’ãƒƒãƒˆã™ã‚Œã°è¿”ã‚Šå€¤ãŒtrueã«ãªã‚Šã¾ã™ã€‚

**`hitTestSelf()`** ã§ã¯è‡ªèº«ãŒHitTestã®å¯¾è±¡ã«ãªã‚‹ã‹ã‚’è¿”ã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯falseã§ã™ãŒHitTestã«å«ã‚ãŸã„ã‚‚ã®ã€ä¾‹ãˆã°`RenderListTile`(`ListTile`ã®RenderObject)ã¯trueã‚’è¿”ã—ã¾ã™ã€‚

ã“ã®`hitTest()`ã‚’æœ«ç«¯ã¾ã§ç¹°ã‚Šè¿”ã™ã“ã¨ã§pointerã®ä½ç½®ã«å¿œã˜ãŸHitTestã®ãƒªã‚¹ãƒˆãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚ã¾ãŸ`hitTest()`ã®ã‚³ãƒ¼ãƒ‰ã®é€šã‚Šã€å­ã®æ–¹ãŒå…ˆã«è¿½åŠ ã•ã‚Œã‚‹(=æœ«ç«¯ã®è¦ç´ ãŒãƒªã‚¹ãƒˆã®å‰æ–¹ã«æ¥ã‚‹)ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ„ãƒªãƒ¼ã«é©ç”¨ã™ã‚‹

é•·ããªã‚Šã¾ã—ãŸãŒã€ã©ã“ã‚’è¦‹ã¦ã„ãŸã®ã‹ã¨ã„ã†ã¨`GestureBinding._handlePointerEventImmediately()`ã§ã—ãŸã€‚`HitTestResult`ã®åˆæœŸåŒ–ãŒçµ‚äº†ã™ã‚‹(orã™ã§ã«ä½œæˆã•ã‚ŒãŸ`HitTestResult`ã‚’å–å¾—ã™ã‚‹)ã¨ã€æ¬¡ã¯`dispatchEvent()`ã‚’å‘¼ã‚“ã§æ¬¡ã®å‡¦ç†ã«å‘ã‹ã„ã¾ã™ã€‚

```dart
// in _handlePointerEventImmediately()
if (hitTestResult != null ||
    event is PointerAddedEvent ||
    event is PointerRemovedEvent) {
  assert(event.position != null);
  dispatchEvent(event, hitTestResult);
}
```

`GestureBinding.dispatchEvent()`ã¯ä¸»è¦ãªéƒ¨åˆ†ã‚’æŠœãå‡ºã™ã¨ä»¥ä¸‹ã®å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚

```dart
void dispatchEvent(PointerEvent event, HitTestResult? hitTestResult) {
  //...
  for (final HitTestEntry entry in hitTestResult.path) {
    try {
      entry.target.handleEvent(event.transformed(entry.transform), entry);
    } //...
  }
}
```

`hitTestResult.path`ã¯å…ˆç¨‹RenderObjectãƒ„ãƒªãƒ¼ã‚’èµ°æŸ»ã—ã¦é›†ã‚ãŸRenderObjectã®ãƒªã‚¹ãƒˆã§ã™ã€‚ã‚ˆã£ã¦ãã‚Œã‚‰ã®`handleEvent()`ã‚’é †ã«å‘¼ã‚“ã§ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç©ºãªã®ã§å®Ÿè£…ã®ä¸­èº«ã®ãªã„å ´åˆã‚‚å¤šã„ã§ã™ã€‚ä½¿ã£ã¦ã„ã‚‹ã‚‚ã®ã¯ä¾‹ãˆã°`RenderMouseRegion`ã§ã¯ã€ãƒã‚¦ã‚¹ã®Hoverã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã«`handleEvent()`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

æœ€ã‚‚é‡è¦ãªã®ã¯`RenderPointerListener.handleEvent()`ã§ã™ã€‚

```dart
void handleEvent(PointerEvent event, HitTestEntry entry) {
  assert(debugHandleEvent(event, entry));
  if (event is PointerDownEvent)
    return onPointerDown?.call(event);
  if (event is PointerMoveEvent)
    return onPointerMove?.call(event);
  if (event is PointerUpEvent)
    return onPointerUp?.call(event);
  if (event is PointerHoverEvent)
    return onPointerHover?.call(event);
  if (event is PointerCancelEvent)
    return onPointerCancel?.call(event);
  if (event is PointerSignalEvent)
    return onPointerSignal?.call(event);
}
```

https://api.flutter.dev/flutter/rendering/RenderPointerListener/handleEvent.html

ã“ã‚Œã¯`Listener`ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®RenderObjectã§ã€æµã‚Œã¦ããŸ`PointerEvent`ã®ç¨®é¡ã‹ã‚‰ç™»éŒ²ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

@[codepen](https://codepen.io/organic-nailer/pen/mdpVPWx)

ä¸Šã®ä¾‹ã‚’è¦‹ã‚‹ã¨ã€`Listener`ã«ã‚ˆã‚Š`PointerDownEvent`ãŒå‡¦ç†ã§ãã¦ã„ã‚‹æ§˜å­ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¾ãŸ`handleEvent()`ã¯ãƒ„ãƒªãƒ¼ã®å…ˆç«¯ã‹ã‚‰æ ¹ã¾ã§å…¨ã¦å‘¼ã³å‡ºã™ãŸã‚ã€ä¸­ã®å››è§’ã‚’æŠ¼ã—ãŸã¨ãã§ã‚‚å¤–ã®`Listener`ã‚‚åŒæ™‚ã«åå¿œã™ã‚‹(é †åºã§ã¯å†…å´ã®æ–¹ãŒå…ˆã«å‘¼ã°ã‚Œã‚‹)ã¨ã„ã†ã“ã¨ã‚‚ç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚


### `GestureBinding`ã‚‚HitTestç™»éŒ²ã—ã¦ã¾ã›ã‚“ã§ã—ãŸã£ã‘ï¼Ÿ

`GestureBinding.hitTest()`ã§ã¯è‡ªåˆ†è‡ªèº«ã‚’`HitTestResult`ã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã¤ã¾ã‚Š`dispatchEvent()`ã‚’å®Ÿè¡Œã™ã‚‹ã¨å¿…ãšæœ€å¾Œã«`GestureBinding.handleEvent()`ãŒå‘¼ã°ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

https://api.flutter.dev/flutter/gestures/GestureBinding/handleEvent.html

è‰²ã€…ãªã‚‚ã®ãŒå‹•ã„ã¦ã„ã‚‹æ°—é…ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ã‚¹ã‚¯ãªã®ã§å‰²æ„›ã—ã¾ã™ã€‚

## Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã¨ã‚

- Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å—ã‘å–ã£ãŸ`PointerEvent`ã‚’è©²å½“ã™ã‚‹RenderObjectã«æµã™
- `PointerEvent`ã¯pointerã«ã‚ˆã‚Šå‹•ãã‚’ç®¡ç†ã—ã¦ã„ã‚‹
- `Listener`ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã«ã‚ˆã‚Š`PointerEvent`ã‚’ç›£è¦–ã§ãã‚‹
- `Listener`ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯é‡ã­ã‚‹ã¨å…¨ã¦åå¿œã™ã‚‹

å®Ÿéš›ã«Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç›´æ¥ã„ã˜ã‚‹ã“ã¨ã¯ãªãã€ä¸Šä½ã®Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¦æ§‹ç¯‰ã•ã‚Œã‚‹`GestureDetector`ã‚„ãƒœã‚¿ãƒ³ãªã©ã‚’åˆ©ç”¨ã™ã‚‹ã®ã¿ã¨æ€ã„ã¾ã™ã€‚

æ¬¡å›ã¯Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç´¹ä»‹ã—ã¾ã™...

https://zenn.dev/fastriver/articles/cb8f5a2a019715