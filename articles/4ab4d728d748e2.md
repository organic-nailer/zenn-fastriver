---
title: "InheritedWidgetã®è£å´ã‚’èª­ã‚€"
emoji: "ğŸ—ï¸"
type: "tech"
topics: ["flutter"]
published: true
published_at: "2022-04-09 12:12"
---

InheritedWidgetã¯ã€æ•°ã‚ã‚‹Flutterã®Widgetã®ä¸­ã§ã‚‚ã‹ãªã‚Šç‰¹æ®Šãªéƒ¨é¡ã«å…¥ã‚Šã¾ã™ã€‚ä»Šæ—¥ã§ã¯ç›´æ¥æ‰±ã†ã“ã¨ã‚‚å°‘ãªããªã‚Šã¾ã—ãŸãŒã€Providerã‚‚å†…éƒ¨ã§ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã«ã€Flutterã®ä¸­æ ¸ã¨ãªã‚‹ä»•çµ„ã¿ã®ä¸€ã¤ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
InheritedWidgetã®å½¹å‰²ãŒã©ã®ã‚ˆã†ã«å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã£ã¦ç†è§£ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# InheritedWidgetã¨ã¯

è©³ã—ã„èª¬æ˜ã¯å¤šãã®è¨˜äº‹ãŒå­˜åœ¨ã™ã‚‹ã®ã§ãã¡ã‚‰ã‚’è¦‹ã¦ãã ã•ã„ã€‚

https://api.flutter.dev/flutter/widgets/InheritedWidget-class.html

https://medium.com/flutter-jp/inherited-widget-37495200d965

https://qiita.com/agajo/items/375d5415cb79689a925c

InheritedWidgetã®æŒã¤é‡è¦ãªå½¹å‰²ã¯ã€

1. ä¸‹ä½ãƒ„ãƒªãƒ¼ã‹ã‚‰`O(1)`ã§(å®šæ•°æ™‚é–“ã§)ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
2. è‡ªèº«ã‚’ç›£è¦–ã™ã‚‹Widgetã«å¤‰æ›´ã‚’é€šçŸ¥ã™ã‚‹

ã®2ã¤ã§ã™ã€‚

# ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã†ãŸã‚ã®å‰æçŸ¥è­˜

- InheritedWidgetã®ä¸€èˆ¬çš„ãªä½¿ã„æ–¹
- Elementãƒ„ãƒªãƒ¼ã®å­˜åœ¨

InheritedWidgetã®ä»•çµ„ã¿ã¯Elementãƒ„ãƒªãƒ¼å†…ã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€2ã¤ç›®ã®ç†è§£ã¯ã‚ã‚‹ç¨‹åº¦å¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã®è¨˜äº‹ãªã©ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://zenn.dev/chooyan/books/934f823764db62/viewer/dfe2d1

# InheritedWidgetã¨InheritedElement

```dart
abstract class InheritedWidget extends ProxyWidget {
  const InheritedWidget({ Key? key, required Widget child })
    : super(key: key, child: child);

  @override
  InheritedElement createElement() => InheritedElement(this);

  @protected
  bool updateShouldNotify(covariant InheritedWidget oldWidget);
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L1684

InheritedWidgetè‡ªä½“ã®å®Ÿè£…ã¯ä»¥ä¸Šã§ã™ã€‚updateShouldNotifyã¯InheritedWidgetã‚’ç¶™æ‰¿ã—ãŸéš›ã«å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’è¦‹ã‚‹ã¨InheritedWidgetã®å½¹å‰²ã¯InheritedElementã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã®ã¿ã§ã™ã€‚

:::message
ProxyWidgetã¯childã‚’æŒã¤ã ã‘ã®Widgetã§ã™ã€‚å®Ÿè£…ã¯ã»ã¼ä½•ã‚‚ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
:::

```dart
abstract class ProxyElement extends ComponentElement

class InheritedElement extends ProxyElement
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5196

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5089

InheritedElementã¯ProxyElementã‚’ç¶™æ‰¿ã—ãŸElementã§ã€ã•ã‚‰ã«ProxyElementã¯StatefulElementã‚„StatelessElementãªã©ã¨å…±é€šã—ã¦ComponentElementã‚’ç¶™æ‰¿ã—ã¦ã„ã¾ã™ã€‚
ä¸­ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯å¿…è¦ã«å¿œã˜ã¦èª¬æ˜ã—ã¾ã™ã€‚

# Elementãƒ„ãƒªãƒ¼ã®ä½œæˆæ™‚

InheritedWidgetã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€Elementãƒ„ãƒªãƒ¼ã‚’æ§‹ç¯‰ã™ã‚‹ã¨ãã«æº–å‚™ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

```dart
void mount(Element? parent, Object? newSlot) {
  //...
  _updateInheritance();
}
```

https://api.flutter.dev/flutter/widgets/Element/mount.html

Element.mount()ã¯Elementã‚’åˆã‚ã¦ãƒ„ãƒªãƒ¼ã«å…¥ã‚Œã‚‹ã¨ãã«å‘¼ã°ã‚Œã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚ãã®æœ€å¾Œã«Element._updateInheritance()ãŒå‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯åå‰ã®é€šã‚ŠInheritedWidgetã®æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ä¸­èº«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```dart
Map<Type, InheritedElement>? _inheritedWidgets;
//...
void _updateInheritance() {
  assert(_lifecycleState == _ElementLifecycle.active);
  _inheritedWidgets = _parent?._inheritedWidgets;
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L4198

è¦ªã®Elementã‹ã‚‰InheritedWidgetã®Mapã‚’ãã®ã¾ã¾å—ã‘ç¶™ã„ã§ã„ã¾ã™ã€‚ã§ã¯ã“ã®Mapã¯ã©ã“ã§æ›¸ãè¾¼ã¾ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
å®Ÿã¯å…ˆç¨‹ã®InheritedElementã§Element._updateInheritance()ãŒoverrideã•ã‚Œã¦ã„ã¾ã™ã€‚

```dart
void _updateInheritance() {
  assert(_lifecycleState == _ElementLifecycle.active);
  final Map<Type, InheritedElement>? incomingWidgets = _parent?._inheritedWidgets;
  if (incomingWidgets != null)
    _inheritedWidgets = HashMap<Type, InheritedElement>.of(incomingWidgets);
  else
    _inheritedWidgets = HashMap<Type, InheritedElement>();
  _inheritedWidgets![widget.runtimeType] = this;
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5206

ã“ã“ã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚

1. è¦ªãŒMapã‚’æŒã£ã¦ã„ãŸã‚‰ã‚³ãƒ”ãƒ¼ã—ã€æŒã£ã¦ã„ãªã‘ã‚Œã°æ–°ãŸã«ä½œæˆ
2. è‡ªèº«ã‚’è‡ªèº«ã®å‹ã‚’keyã«ã—ã¦Mapã«è¿½åŠ ã™ã‚‹

ã“ã‚Œã‚‰ã‹ã‚‰ã€ãã‚Œãã‚Œã®Elementã®_inheritedWidgetsã«ã¯è‡ªèº«ã‚ˆã‚Šä¸Šä½ã«ã‚ã‚‹InheritedElementãŒMapå½¢å¼ã§æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

æ³¨æ„ã—ã¦ã»ã—ã„ã®ã¯ã€keyã‚’InheritedWidgetã®å‹ã¨ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚ã“ã®ãŸã‚ãƒ„ãƒªãƒ¼ä¸Šã«åŒã˜å‹ã®InheritedWidgetãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€ä¸€ç•ªè¿‘ã„ã‚‚ã®ã®ã¿ã®å‚ç…§ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ã«ãªã£ã¦ã„ã¾ã™ã€‚

:::message
ã“ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ä¾‹ãˆã°Themeãªã©ã‚’ãƒ«ãƒ¼ãƒˆã§å®šç¾©ã—ã¦ã„ã¦ã‚‚ãƒ„ãƒªãƒ¼ã®é€”ä¸­ã«ã‚ã‚‰ãŸã«Themeã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ãã‚Œä»¥ä¸‹ã®WidgetãŒå‚ç…§ã™ã‚‹Themeã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
:::

> ã‚ˆãè€ƒãˆã‚‹ã¨inheritedWidgetsã¨ã„ã†åå‰ãªã®ã«å…¥ã£ã¦ã„ã‚‹ã®ã¯InheritedElementsãªã®ã€ã‚„ã‚„ã“ã—ã„

# ç›£è¦–ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

context.getElementForInheritedWidgetOfExactType<ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‹>()ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ç¥–å…ˆã®InheritedElementã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãšBuildContextã®å®Ÿæ…‹ã¯å¯¾å¿œã™ã‚‹Elementã§ã™ã€‚

```dart
InheritedElement? getElementForInheritedWidgetOfExactType<T extends InheritedWidget>() {
  assert(_debugCheckStateIsActiveForAncestorLookup());
  final InheritedElement? ancestor = _inheritedWidgets == null ? null : _inheritedWidgets![T];
  return ancestor;
}
```

https://api.flutter.dev/flutter/widgets/Element/getElementForInheritedWidgetOfExactType.html

ä¸­èº«ã¯å˜ç´”ã§ã€Elementãƒ„ãƒªãƒ¼ã®æ§‹ç¯‰æ™‚ã«æ›´æ–°ã—ãŸ_inheritedWidgetsã‹ã‚‰å¯¾å¿œã—ãŸå‹ã®Elementã‚’å–ã‚Šå‡ºã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚å½“ç„¶ã‚¢ã‚¯ã‚»ã‚¹é€Ÿåº¦ã¯O(1)ã€å®šæ•°æ™‚é–“ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã ã‘ãªã®ã§å€¤ã®å¤‰æ›´ã®ç›£è¦–ãªã©ã‚‚è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

# ç›£è¦–ã‚ã‚Šã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

context.dependOnInheritedWidgetOfExactType<ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å‹>()ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ç¥–å…ˆã®InheritedWidgetã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã“ã¡ã‚‰ã¯ãã®InheritedWidgetã®å€¤ãŒå¤‰ã‚ã£ãŸã¨ãã«é€šçŸ¥ã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
Element.dependOnInheritedWidgetOfExactType()ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```dart
T? dependOnInheritedWidgetOfExactType<T extends InheritedWidget>({Object? aspect}) {
  assert(_debugCheckStateIsActiveForAncestorLookup());
  final InheritedElement? ancestor = _inheritedWidgets == null ? null : _inheritedWidgets![T];
  if (ancestor != null) {
    return dependOnInheritedElement(ancestor, aspect: aspect) as T;
  }
  _hadUnsatisfiedDependencies = true;
  return null;
}

//...

InheritedWidget dependOnInheritedElement(InheritedElement ancestor, { Object? aspect }) {
  //...
  ancestor.updateDependencies(this, aspect);
  return ancestor.widget;
}
```

https://api.flutter.dev/flutter/widgets/Element/dependOnInheritedWidgetOfExactType.html

ã“ã¡ã‚‰ã‚‚å‰åŠã¯åŒã˜ã_inheritedWidgetsã‹ã‚‰å¯¾å¿œã™ã‚‹InheritedElementã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚ç•°ãªã‚‹ã®ã¯å¾ŒåŠéƒ¨åˆ†ã§ã€ancestorãŒè¦‹ã¤ã‹ã£ãŸå ´åˆElement.dependOnInheritedElement()ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

:::message
aspectã¯ã‚ˆã‚Šç´°ã‹ãªé€šçŸ¥åˆ¶å¾¡ãŒã§ãã‚‹InheritedModelã¨ã„ã†ä¸Šä½ã‚¯ãƒ©ã‚¹ã®ãŸã‚ã«ä½¿ã†Objectã§ã™ã€‚InheritedWidgetã®ä»•çµ„ã¿å†…ã§ã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚
:::

dependOnInheritedElementå†…ã§ã¯ã€widgetã‚’è¿”ã™å‰ã«ancestor.updateDependencies()ã‚’å‘¼ã‚“ã§è‡ªèº«ã®Elementã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚

```dart
final Map<Element, Object?> _dependents = HashMap<Element, Object?>();

void updateDependencies(Element dependent, Object? aspect) {
  setDependencies(dependent, null);
}

void setDependencies(Element dependent, Object? value) {
  _dependents[dependent] = value;
}
```

https://api.flutter.dev/flutter/widgets/InheritedElement/updateDependencies.html

InheritedElementã§ã“ã‚ŒãŒå‘¼ã°ã‚Œã‚‹ã¨ã€ãã®Elementã‚’_dependentsã¨ã„ã†Mapã«æ ¼ç´ã—ã¾ã™(å‰è¿°ã®é€šã‚Šaspectã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“)ã€‚ã“ã‚Œã§InheritedElementã‚’ç›£è¦–ã™ã‚‹ElementãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚

## InheritedWidgetãŒæ›´æ–°ã•ã‚ŒãŸã¨ã

ä½•ã‚‰ã‹ã®è¦å› ã§Widgetãƒ„ãƒªãƒ¼å†…ã®InheritedWidgetãŒæ›´æ–°(å·®ã—æ›¿ãˆ)ã•ã‚Œã€InheritedElementè‡ªä½“ã¯ä½¿ã„å›ã•ã‚Œã‚‹ã¨ãã‚’è€ƒãˆã¾ã™ã€‚ãã®å ´åˆElement.update(newWidget)ãŒæ›´æ–°ã®ãŸã‚å‘¼ã°ã‚Œã¾ã™ã€‚
InheritedElementã¯ProxyElementã§updateãŒoverrideã•ã‚Œã¦ã„ã¾ã™ã€‚

```dart
void update(ProxyWidget newWidget) {
  final ProxyWidget oldWidget = widget;
  assert(widget != null);
  assert(widget != newWidget);
  super.update(newWidget);
  assert(widget == newWidget);
  updated(oldWidget);
  _dirty = true;
  rebuild();
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5100

super.updateã§WidgetãŒæ–°ã—ã„ã‚‚ã®ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠã„ãŸoldWidgetã‚’ä½¿ã„ãã®å¾ŒInheritedElement.updated(oldWidget)ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```dart
void updated(InheritedWidget oldWidget) {
  if (widget.updateShouldNotify(oldWidget))
    super.updated(oldWidget);
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5336

ã“ã“ã§ã€é–‹ç™ºè€…ã®å®šç¾©ã—ãŸInheritedWidget.updateShouldNotify()ã‚’è¦‹ã¦ã„ã¦ã€trueã‚’è¿”ã™å ´åˆã®ã¿ProxyElement.updated()ã‚’å‘¼ã¶ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```dart
void updated(covariant ProxyWidget oldWidget) {
  notifyClients(oldWidget);
}
```

https://github.com/flutter/flutter/blob/c860cba910319332564e1e9d470a17074c1f2dfd/packages/flutter/lib/src/widgets/framework.dart#L5117

ã“ã“ã¯InheritedElement.notifyClient()ã‚’å‘¼ã¶ã ã‘ã§ã™ã€‚

```dart
void notifyClients(InheritedWidget oldWidget) {
  assert(_debugCheckOwnerBuildTargetExists('notifyClients'));
  for (final Element dependent in _dependents.keys) {
    //...
    notifyDependent(oldWidget, dependent);
  }
}

void notifyDependent(covariant InheritedWidget oldWidget, Element dependent) {
  dependent.didChangeDependencies();
}
```

https://api.flutter.dev/flutter/widgets/InheritedElement/notifyClients.html

ã“ã“ã§å…ˆç¨‹ç›£è¦–ã—ã¦ã„ã‚‹Elementã®ä¸€è¦§ã¨ã—ã¦ä½œã£ãŸInheritedElement._dependentsãŒä½¿ã‚ã‚Œã¾ã™ã€‚æœ€çµ‚çš„ã«ãã‚Œãã‚Œã®Elementã®Element.didChangeDependencies()ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ã‘ã§ã™ã€‚

```dart
void didChangeDependencies() {
  assert(_lifecycleState == _ElementLifecycle.active); // otherwise markNeedsBuild is a no-op
  assert(_debugCheckOwnerBuildTargetExists('didChangeDependencies'));
  markNeedsBuild();
}
```

https://api.flutter.dev/flutter/widgets/Element/didChangeDependencies.html

ã“ã“ãŒæœ€å¾Œã§ã™ã€‚å¯¾è±¡ã®Elementã¯Element.markNeedsBuild()ãŒå‘¼ã°ã‚Œã¦needsBuildãƒ•ãƒ©ã‚°ãŒç«‹ã¡ã€ãã®å¾Œã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ã‚‹å†ãƒ“ãƒ«ãƒ‰å·¥ç¨‹ã§ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

çµ‚ã‚ã‚Š