---
title: "Flutterã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†æ¢è¨ªâ‘¡ Gesture"
emoji: "ğŸ¤™"
type: "tech"
topics: ["flutter"]
published: true
published_at: "2022-03-19 16:53"
---

å‰å›ã®è¨˜äº‹ã¯â†“

https://zenn.dev/fastriver/articles/3d0f93d65b7ebf

ã•ã¦ã€UIæ“ä½œã«ãŠã„ã¦ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã¯éå¸¸ã«é‡è¦ãªèª²é¡Œã§ã™ã€‚Flutterã§ã¯ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’2ã¤ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«åˆ†ã‘ã¦å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã‚ã‚‹Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¤ã„ã¦ã¯å‰å›ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ä»Šå›ã¯ä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¤ã„ã¦å®Ÿè£…ã‚’è¿½ã„ãªãŒã‚‰ã©ã®ã‚ˆã†ãªä»•çµ„ã¿ã§å‹•ã„ã¦ã„ã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

# Gestureã¨ã¯

![](https://storage.googleapis.com/zenn-user-upload/f0db73aebe69-20220318.png)

> https://medium.com/litslink/flutter-gesturedetector-86fc937aaf17 ã‚ˆã‚Šå¼•ç”¨

Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸ/ç§»å‹•ã—ãŸ/é›¢ã‚ŒãŸã¨ãã‚’æ¤œçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã—ã‹ã—ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ã†ã ã‘ã§ã¯é©åˆ‡ãªã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’è¡Œã†ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚å˜ç´”ãªã‚¿ãƒƒãƒ—ã‚’æ¤œçŸ¥ã—ãŸã„å ´åˆã§ã‚‚ã€PointerUpã‚’ç›£è¦–ã™ã‚‹ã®ã¿ã§ã¯ä¾‹ãˆã°æŒ‡ã‚’ãšã‚‰ã—ã¦ã‹ã‚‰é›¢ã—ãŸæ™‚ã«ã‚‚åå¿œã—ã¦ã—ã¾ã„ã¾ã™ã€‚
ã¾ãŸä¸Šã®ç”»åƒã®ã‚ˆã†ã«å®Ÿéš›ã®ç”»é¢ã§ã¯æ§˜ã€…ãªãƒã‚¤ãƒ³ã‚¿ã®å‹•ãã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãŒã©ã®å‹•ãã‚’æ„å›³ã—ã¦è¡Œã£ãŸã®ã‹ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Flutterã¯ä¸Šã®ã‚ˆã†ãªTap/Double Tap/Horizontal Drag/Pinch Inãªã©ãã‚Œãã‚Œã‚’1ã¤ã®Gestureã§ã‚ã‚‹ã¨è€ƒãˆã€ãƒã‚¤ãƒ³ã‚¿ã®æŒ™å‹•ã‹ã‚‰1ã¤ã®Gestureã‚’é¸æŠã—ã¦ã„ã¾ã™ã€‚

ã§ã¯ã©ã®ã‚ˆã†ã«è¤‡æ•°ã®Gestureã®å€™è£œã‹ã‚‰1ã¤ã‚’é¸ã³å‡ºã™ã®ã‹ã€‚
**é—˜æŠ€å ´(Arena)ã§GestureåŒå£«ã‚’æˆ¦ã‚ã›ã‚‹ã®ã§ã™ï¼ï¼**

https://qiita.com/mjhd/items/8e300238e494d8755b44

# ç™»å ´äººç‰©

## é—˜æŠ€å ´(_GestureArena)

https://github.com/flutter/flutter/blob/f9c4b227213fe468bf221d2413d575cd446069dd/packages/flutter/lib/src/gestures/arena.dart#L57

> ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¯ãƒ©ã‚¹ãªã®ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã„ã€‚

é—˜æŠ€å ´ã§ã™ã€‚ã“ã®é—˜æŠ€å ´ã«å‚åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼(`GestureArenaMemeber`)ã®ãƒªã‚¹ãƒˆã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã€çŠ¶æ…‹ã®å¤‰æ›´ãªã©ã¯å…¨ã¦`GestureArenaManager`ã‹ã‚‰è¡Œã„ã¾ã™ã€‚

PointerEventã¯æŒ‡ã®è»Œè·¡ã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªid(pointer)ã‚’æŒ¯ã£ã¦ã„ã¾ã™ã€‚é—˜æŠ€å ´ã¯ãã®pointer1ã¤ã«ã¤ã1ã¤ä¼šå ´ãŒç”¨æ„ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

## GestureArenaManager

https://api.flutter.dev/flutter/gestures/GestureArenaManager-class.html

é—˜æŠ€å ´ã®ä½œæˆãƒ»å‰Šé™¤ãƒ»çŠ¶æ…‹å¤‰æ›´ãªã©ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã€`GestureBinding.gestureArena`ã¨ã„ã†ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å­˜åœ¨ã—ã¾ã™(ã‚„ã‚„ã“ã—ã„)ã€‚

é—˜æŠ€å ´ã®å‹æ•—åˆ¤å®šã‚‚ã“ã®ã‚¯ãƒ©ã‚¹ãŒè¡Œã£ã¦ã„ã¾ã™ã€‚

## å‚åŠ è€…(GestureArenaMember)

https://api.flutter.dev/flutter/gestures/GestureArenaMember-class.html

é—˜æŠ€å ´ã®å‚åŠ è€…ã«ãªã‚Šã†ã‚‹interfaceã§ã™ã€‚
é—˜æŠ€å ´ã§å‹åˆ©/æ•—åŒ—ãŒæ±ºå®šã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹é–¢æ•°ã‚’æŒã¤ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

å®Ÿè£…ã¯`GestureRecognizer`ãŒæŒã¡ã¾ã™ã€‚

### GestureRecognizer

https://api.flutter.dev/flutter/gestures/GestureRecognizer-class.html

Gestureã‚’èªè­˜ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚ãã‚Œãã‚Œã®Gestureã”ã¨ã«ã“ã‚Œã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ç›£è¦–å¯¾è±¡ã®`GestureArenaEntry`ã®ãƒªã‚¹ãƒˆã‚’æŒã£ã¦ã„ã¾ã™ã€‚

## GestureArenaEntry

https://api.flutter.dev/flutter/gestures/GestureArenaEntry-class.html

ã‚ã‚‹pointerã®æ‰€å±ã™ã‚‹`GestureArenaMember`ã¨`GestureArenaManager`ã®æƒ…å ±ã‚’æŒã¤ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

## GestureArenaTeam

https://api.flutter.dev/flutter/gestures/GestureArenaTeam-class.html

é—˜æŠ€å ´å†…ã§è¤‡æ•°ã®`GestureArenaMember`ãŒãƒãƒ¼ãƒ ã‚’çµ„ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚ãã®ãƒãƒ¼ãƒ ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚ã¾ãŸãƒãƒ¼ãƒ å†…ã§ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã‚’æ±ºã‚ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

ãƒãƒ¼ãƒ ã‚’çµ„ã‚€ã®ã¯ç‰¹åˆ¥ãªã‚±ãƒ¼ã‚¹ãªã®ã§ã‚ã¾ã‚Šèª¬æ˜ã—ã¾ã›ã‚“ãŒã€ä»•çµ„ã¿ã¯:

- é—˜æŠ€å ´ã«åŒã˜ãƒãƒ¼ãƒ ã®ãƒ¡ãƒ³ãƒãƒ¼ã—ã‹ã„ãªããªã£ãŸå ´åˆ
	- ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãŒã„ã‚Œã°ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãŒå‹åˆ©(ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯æ•—åŒ—)
	- ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãŒä¸åœ¨ãªã‚‰æœ€åˆã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‹åˆ©(ã»ã‹ã¯æ•—åŒ—)

ã¨ã„ã†ã‚ˆã†ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

## PointerRouter

https://api.flutter.dev/flutter/gestures/PointerRouter-class.html

é—˜æŠ€å ´ã¨ã¯åˆ¥ã§å‹•ã„ã¦ã„ã‚‹ã‚‚ã®ã§ã™ãŒã€ç‰¹å®šã®`PointerEvent`ãŒããŸã¨ãã«`GestureRecognizer`ã«ãã‚Œã‚’é€ä¿¡ã™ã‚‹å ´æ‰€(é–¢æ•°)ã‚’ç™»éŒ²ã—ã¦ãŠãã‚¯ãƒ©ã‚¹ã§ã™ã€‚ã»ã¨ã‚“ã©é—˜æŠ€å ´å˜ä½ã§é€ä¿¡ã—ã¦ã„ã‚‹ã‚‚ã®ã¨æ€ã‚ã‚Œã¾ã™ã€‚

# 1.é—˜æŠ€å ´ã®é–‹å‚¬

## ãƒ„ãƒªãƒ¼ã®æ§‹ç¯‰

![](https://storage.googleapis.com/zenn-user-upload/aa18fa82184a-20220319.jpg)

Gestureã®é—˜æŠ€å ´ãŒã©ã®ã‚ˆã†ã«å‹•ãã®ã‹ã‚’è¦‹ã‚‹ãŸã‚ã«ã€å›³ã®ã‚ˆã†ãªãƒ„ãƒªãƒ¼ã«2ã¤ã®`GestureDetector`ã‚’å«ã‚“ã ã‚¢ãƒ—ãƒªã®ä¾‹ã‚’è€ƒãˆã‚‹ã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚
`GestureDetector`ã‚’Widgetã¨ã—ã¦ä½¿ã†ã¨ã€Widgetãƒ„ãƒªãƒ¼ã«ã¯`Listener`ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
(å®Ÿéš›ã«è¿½åŠ ã—ã¦ã„ã‚‹ã®ã¯`GestureDetector`ã®ä½ãƒ¬ã‚¤ãƒ¤ã‚’æä¾›ã—ã¦ã„ã‚‹`RawGestureDetector`(ã®State)ã®`build`éƒ¨åˆ†ã«ãªã‚Šã¾ã™ã€‚)

```dart
  Widget build(BuildContext context) {
    Widget result = Listener(
      onPointerDown: _handlePointerDown,
      behavior: widget.behavior ?? _defaultBehavior,
      child: widget.child,
    );
    if (!widget.excludeFromSemantics) {
      result = _GestureSemantics(
        behavior: widget.behavior ?? _defaultBehavior,
        assignSemantics: _updateSemanticsForRenderObject,
        child: result,
      );
    }
    return result;
  }
```

https://api.flutter.dev/flutter/widgets/RawGestureDetectorState/build.html

ã“ã®ãŸã‚2ã¤ã®`GestureDetector`ã‚’å«ã‚€ãƒ„ãƒªãƒ¼ã¯2ã¤ã®`Listener`(æ­£ã—ãã¯`Listener`ã¨å¯¾å¿œã™ã‚‹RenderObjectã§ã‚ã‚‹`RenderPointerListener`)ã®ã‚ã‚‹Renderãƒ„ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

:::message
å›³ã§ã¯åˆ†ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚Renderãƒ„ãƒªãƒ¼ã«"Listener"ã¨æ›¸ã„ã¦ã„ã¾ã™
:::

## Recognizerã®å‚åŠ 

![](https://storage.googleapis.com/zenn-user-upload/5202164acab1-20220319.jpg)

æ¬¡ã«`PointerDownEvent`ãŒæµã‚Œã¦ããŸã¨ãã®ã“ã¨ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚ã“ã®è¾ºã‚Šã¯ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’è¸è¥²ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®ä½ç½®ã¯2ã¤ã®`GestureDetector`ã®åå¿œã™ã‚‹ä½ç½®ã ã¨ã—ã¾ã™ã€‚

https://zenn.dev/fastriver/articles/3d0f93d65b7ebf#pointerevent%E3%81%A8%E3%81%AF

åŒä¸€pointerã§ã¯

PointerDown -> PointerMove -> PointerUp

ã¨ã„ã†ä¸€é€£ã®é †ç•ªã§æµã‚Œã¦ãã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹ãŸã‚ã€PointerDownEventã®æŒã¤pointerã¯æ–°è¦ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã§ã‚ã‚‹ã‚ã‘ã§ã™ã€‚
ã™ã‚‹ã¨Gestureãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é—˜æŠ€å ´ã‚’ä½œã‚‹æº–å‚™ã‚’è¡Œã„ã¾ã™ã€‚

å›³ã‚’è¦‹ã‚‹ã¨ã€PointerEventã¯Pointerãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æ²¿ã£ã¦Renderãƒ„ãƒªãƒ¼ã‚’ä¸‹ã‹ã‚‰é¡ã£ã¦é †ã«`handleEvent()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ãã¾ã™ã€‚
`Listener`ã¯ãã‚Œã«åˆã‚ã›ã¦ç™»éŒ²ã•ã‚ŒãŸ`onPointerDown`ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

`GestureDetector`ã®å ´åˆã¯`RawGestureDetectorState._handlePointerDown()`ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

```dart
  void _handlePointerDown(PointerDownEvent event) {
    assert(_recognizers != null);
    for (final GestureRecognizer recognizer in _recognizers!.values)
      recognizer.addPointer(event);
  }
```

https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/widgets/gesture_detector.dart#L1432

é–¢æ•°å†…ã§`_recognizers`ã”ã¨ã«`GestureRecognizer.addPointer()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã­ã€‚`_recognizers`ã«ã¯`GestureDetector`ã«æŒ‡å®šã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å…ƒã«ä½œã‚‰ã‚ŒãŸ`GestureRecognizer`ãŸã¡ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚è©³ã—ãã¯

[`GestureDetector.build()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/widgets/gesture_detector.dart#L959)
-> [`RawGestureDetectorState.initState()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/widgets/gesture_detector.dart#L1327)
-> [`RawGestureDetectorState._syncAll()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/widgets/gesture_detector.dart#L1414)

ã‚’è¦‹ã‚‹ã¨Recognizerã®ç”ŸæˆçŠ¶æ³ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

`GestureRecognizer.addPointer()`ã®å…ˆã¯ç¨®é¡ã«ã‚ˆã£ã¦ç•°ãªã‚‹ã®ã§ã™ãŒã€ä¾‹ãˆã°`OneSequenceGestureRecognizer`ã§ã¯

[`GestureRecognizer.addPointer()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/gestures/recognizer.dart#L114)
-> [`OneSequenceGestureRecognizer.addAllowedPointer()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/gestures/recognizer.dart#L257)
-> [`OneSequenceGestureRecognizer.startTrackingPointer()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/gestures/recognizer.dart#L373)
-> [`OneSequenceGestureRecognizer._addPointerToArena()`](https://github.com/flutter/flutter/blob/de4eb162549a2b479bb547d1e86b43e66c65bd57/packages/flutter/lib/src/gestures/recognizer.dart#L352)

ã¨ã„ã†é †ã«å‘¼ã°ã‚Œã¦ã„ãã¾ã™ã€‚ã“ã®æµã‚Œã®ä¸­ã§GestureRecognizerãŒé—˜æŠ€å ´ã¨`PointerRouter`ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```dart
  GestureArenaEntry _addPointerToArena(int pointer) {
    if (_team != null)
      return _team!.add(pointer, this);
    return GestureBinding.instance.gestureArena.add(pointer, this);
  }

  void startTrackingPointer(int pointer, [Matrix4? transform]) {
    GestureBinding.instance.pointerRouter.addRoute(pointer, handleEvent, transform);
    _trackedPointers.add(pointer);
    assert(!_entries.containsValue(pointer));
    _entries[pointer] = _addPointerToArena(pointer);
  }
```

ã¡ãªã¿ã«ã©ã“ã§é—˜æŠ€å ´ãŒæ–°ãŸã«ä½œã‚‰ã‚Œã‚‹ã®ã‹ã¨ã„ã†ã¨ã€æ–°è¦ã®pointerã§`GestureArenaManager.add()`ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã«ãªã‚Šã¾ã™ã€‚

```dart
  GestureArenaEntry add(int pointer, GestureArenaMember member) {
    final _GestureArena state = _arenas.putIfAbsent(pointer, () {
      assert(_debugLogDiagnostic(pointer, 'â˜… Opening new gesture arena.'));
      return _GestureArena();
    });
    state.add(member);
    assert(_debugLogDiagnostic(pointer, 'Adding: $member'));
    return GestureArenaEntry._(this, pointer, member);
  }
```

~~æ˜Ÿã§ã¯ã—ã‚ƒããªã‚ˆ~~

ã“ã®ç™»éŒ²ä½œæ¥­ãŒè©²å½“ã™ã‚‹å…¨ã¦ã®Recognizerã«ã‚ˆã‚Šè¡Œã‚ã‚Œã‚‹ã“ã¨ã§ã€é—˜æŠ€å ´ã®é–‹å‚¬æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

## é—˜æŠ€å ´ã®ç· åˆ‡

![](https://storage.googleapis.com/zenn-user-upload/1d007f6f41df-20220319.jpg)

PointerEventã¯Renderãƒ„ãƒªãƒ¼ã‚’å…¨ã¦èµ°æŸ»ã—ãŸã‚ã¨ã€`GestureBinding.handleEvent()`ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```dart
void handleEvent(PointerEvent event, HitTestEntry entry) {
  pointerRouter.route(event);
  if (event is PointerDownEvent) {
    gestureArena.close(event.pointer);
  } else if (event is PointerUpEvent) {
    gestureArena.sweep(event.pointer);
  } else if (event is PointerSignalEvent) {
    pointerSignalResolver.resolve(event);
  }
}
```

https://api.flutter.dev/flutter/gestures/GestureBinding/handleEvent.html

æœ€åˆã®è¡Œã¯ã‚ã¨ã«å›ã™ã¨ã—ã¦ã€`PointerDownEvent`ãŒå›ã£ã¦ãã‚‹ã¨`GestureArenaManager.close()`ãŒå‘¼ã°ã‚Œã€å½“è©²ã®é—˜æŠ€å ´ã®å‚åŠ ãŒç· ã‚åˆ‡ã‚‰ã‚Œã¾ã™ã€‚
ã“ã“ã‹ã‚‰çœŸã®ãƒãƒˆãƒ«ãŒå§‹ã¾ã‚‹ã‚ã‘ã§ã™â€•â€•

# 2.å‹æ•—ã®åˆ¤å®š

## å¾Œç¶šã‚¤ãƒ™ãƒ³ãƒˆã®å—ã‘å–ã‚Š

![](https://storage.googleapis.com/zenn-user-upload/5e4fbe88ad25-20220319.jpg)

(1ã¤ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚è©²å½“ã—ã¾ã™ãŒ)å¾Œç¶šã®åŒä¸€pointerã‚’æŒã¤PointerEventãŒã‚„ã£ã¦ãã‚‹ã¨ã€`GestureBinding.handleEvent()`å†…ã§å‘¼ã°ã‚Œã‚‹`PointerRouter.route()`ã«ã‚ˆã‚Šç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€ã¤ã¾ã‚ŠRecognizerã®`handleEvent()`ã«æµã•ã‚Œã¾ã™ã€‚
å„Recognizerã¯ã“ã“ã«æµã‚Œã¦ããŸPointerEventã‚’è¦‹ãªãŒã‚‰è‡ªåˆ†ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãªã®ã‹ã‚’è€ƒãˆã‚‹ææ–™ã«ã—ã¾ã™ã€‚

## å‹æ•—ã®å®£è¨€ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‘¼ã³å‡ºã—

é—˜æŠ€å ´ã«å‚åŠ ã—ã¦ã„ã‚‹Recognizerã¯å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‹åˆ©å®£è¨€ã¾ãŸã¯æ•—åŒ—å®£è¨€ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°`OneSequenceGestureRecognizer`ã§ã¯ã€`resolve()`ã«`GestureDisposition.accepted`/`GestureDisposition.regected`ã‚’æ¸¡ã™ã“ã¨ã§å®£è¨€ã—ã¦ã„ã¾ã™ã€‚

```dart
void resolve(GestureDisposition disposition) {
  final List<GestureArenaEntry> localEntries = List<GestureArenaEntry>.of(_entries.values);
  _entries.clear();
  for (final GestureArenaEntry entry in localEntries)
    entry.resolve(disposition);
}
```

https://api.flutter.dev/flutter/gestures/OneSequenceGestureRecognizer/resolve.html

ã“ã“ã§ã¯Recognizerã®æŒã¤`GestureArenaEntry`ã®`resolve`ã‚’çµŒç”±ã—ã¦é—˜æŠ€å ´ã«é€šçŸ¥ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```dart
void resolve(GestureDisposition disposition) {
  _arena._resolve(_pointer, _member, disposition);
}
```

https://api.flutter.dev/flutter/gestures/GestureArenaEntry/resolve.html

ã‚ãã¾ã§RecognizerãŒã§ãã‚‹ã®ã¯å®£è¨€ã®ã¿ã§ã€å®Ÿéš›ã®å‹æ•—ã‚’æ±ºå®šã™ã‚‹ã®ã¯å‘¼ã³å‡ºã•ã‚ŒãŸé—˜æŠ€å ´ã¨Managerã®ä»•äº‹ã§ã™ã€‚

ã¾ãŸã€Recognizerã®ä»•äº‹ã¨ã—ã¦Widgetãªã©ã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‘¼ã³å‡ºã—ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ç§é”ãŒä½œæˆã™ã‚‹`onTapDown`ãªã©ã®ã“ã¨ã§ã€VerticalDragã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãªã‚‰

- `onVerticalDragStart`
- `onVerticalDragDown`
- `onVerticalDragUpdate`
- `onVerticalDragCancel`
- `onVerticalDragEnd`

ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’é©å½“ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‘¼ã³å‡ºã™ã‚ã‘ã§ã™ã€‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ã®ã«ã¯`GestureRecognizer.invokeCallback()`ã‚’ä½¿ã„ã¾ã™ã€‚

https://api.flutter.dev/flutter/gestures/GestureRecognizer/invokeCallback.html

## å‹æ•—åˆ¤å®š1.èª°ã‹ãŒå‹åˆ©å®£è¨€ã—ãŸå ´åˆ

Recognizerã®ä»•äº‹ãŒã‚ã‹ã£ãŸã¨ã“ã‚ã§é—˜æŠ€å ´ã®å‹æ•—åˆ¤å®šæ¡ä»¶ã‚’ä¸€ã¤ã¥ã¤è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ã¾ãšè€ƒãˆã‚‰ã‚Œã‚‹ã®ã¯é—˜æŠ€å ´ã«ã„ã‚‹èª°ã‹ãŒ`resolve(GestureDisposition.accepted)`ã‚’å‘¼ã³å‡ºã—ã¦å‹åˆ©å®£è¨€ã—ãŸå ´åˆã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/80ab27470d32-20220319.jpg)

ä¸Šã®å›³ã®ã‚ˆã†ã«RecognizerAãŒã‚ã‚‹`handleEvent()`ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‹åˆ©å®£è¨€ã—ãŸå ´åˆã‚’è€ƒãˆã¾ã™ã€‚`resolve(GestureDisposition.accepted)`ã‚’å‘¼ã³å‡ºã™ã¨å‰ã«è©±ã—ãŸã‚ˆã†ã«`GestureArenaManager._resolve()`ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

```dart
  void _resolve(int pointer, GestureArenaMember member, GestureDisposition disposition) {
    final _GestureArena? state = _arenas[pointer];
    if (state == null)
      return; // This arena has already resolved.
    assert(_debugLogDiagnostic(pointer, '${ disposition == GestureDisposition.accepted ? "Accepting" : "Rejecting" }: $member'));
    assert(state.members.contains(member));
    if (disposition == GestureDisposition.rejected) {
      state.members.remove(member);
      member.rejectGesture(pointer);
      if (!state.isOpen)
        _tryToResolveArena(pointer, state);
    } else {
      assert(disposition == GestureDisposition.accepted);
      if (state.isOpen) {
        state.eagerWinner ??= member;
      } else {
        assert(_debugLogDiagnostic(pointer, 'Self-declared winner: $member'));
        _resolveInFavorOf(pointer, state, member);
      }
    }
  }
```

https://github.com/flutter/flutter/blob/7e9793dee1b85a243edd0e06cb1658e98b077561/packages/flutter/lib/src/gestures/arena.dart#L206

ã”ã¡ã‚ƒã”ã¡ã‚ƒè‰²ã€…ã‚„ã£ã¦ã„ã¾ã™ãŒã€`disposition`ã¯`accepted`ã§ã‚ã‚Šã€`state.isOpen == false`ãªã®ã§`_resolveInFavorOf()`ãŒå‘¼ã°ã‚Œã‚‹ã ã‘ã§ã™ã€‚

```dart
  void _resolveInFavorOf(int pointer, _GestureArena state, GestureArenaMember member) {
    assert(state == _arenas[pointer]);
    assert(state != null);
    assert(state.eagerWinner == null || state.eagerWinner == member);
    assert(!state.isOpen);
    _arenas.remove(pointer);
    for (final GestureArenaMember rejectedMember in state.members) {
      if (rejectedMember != member)
        rejectedMember.rejectGesture(pointer);
    }
    member.acceptGesture(pointer);
  }
```

https://github.com/flutter/flutter/blob/7e9793dee1b85a243edd0e06cb1658e98b077561/packages/flutter/lib/src/gestures/arena.dart#L254

ã“ã®é–¢æ•°ã§ã¯æŒ‡å®šã•ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼(=å‹åˆ©å®£è¨€ã—ãŸãƒ¡ãƒ³ãƒãƒ¼)ã®ã¿`GestureRecognizer.acceptGesture()`ã‚’å‘¼ã³ã€ä»–ã¯`rejectGesture()`ã‚’å‘¼ã¶ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã­ã€‚

- `acceptGesture()`: å‹åˆ©ç¢ºå®šæ™‚ã«å‘¼ã°ã‚Œã‚‹
- `rejectGesture()`: æ•—åŒ—ç¢ºå®šæ™‚ã«å‘¼ã°ã‚Œã‚‹

ã¨ã„ã†ã“ã¨ã§ã€å‹è€…ãŒæœ€åˆã«å‹åˆ©å®£è¨€ã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã«ãªã‚Šã¾ã—ãŸï¼
å‹åˆ©ãƒ»æ•—åŒ—é€šçŸ¥ã‚’å—ã‘å–ã£ãŸãã‚Œãã‚Œã®Recognizerã¯é©å½“ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã™ãªã©ã—ã¦æ®‹å‹™å‡¦ç†ã‚’è¡Œã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## å‹æ•—åˆ¤å®š2.ãƒ¡ãƒ³ãƒãƒ¼ãŒ1äººã«ãªã£ãŸå ´åˆ

![](https://storage.googleapis.com/zenn-user-upload/3bf2fe0628c9-20220319.jpg)

ã§ã¯ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒæ•—åŒ—å®£è¨€ã—ã¦é—˜æŠ€å ´ã«1äººæ®‹ã£ãŸå ´åˆã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ãã®å ´åˆã‚‚åŒæ§˜ã«å®£è¨€æ™‚ã«`GestureArenaManager._resolve()`ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

```dart
if (disposition == GestureDisposition.rejected) {
  state.members.remove(member);
  member.rejectGesture(pointer);
  if (!state.isOpen)
    _tryToResolveArena(pointer, state);
}
```

æ•—åŒ—å®£è¨€ã‚’ã—ãŸãƒ¡ãƒ³ãƒãƒ¼ã¯é—˜æŠ€å ´ã‹ã‚‰é€€å ´ã•ã›ã‚‰ã‚Œã€æ•—åŒ—é€šçŸ¥ãŒå‘¼ã°ã‚Œã¾ã™ã€‚ã¾ãŸãƒ¡ãƒ³ãƒãƒ¼ãŒæ›´æ–°ã•ã‚ŒãŸã“ã¨ã§`_tryToResolveArena()`ã‚’å‘¼ã‚“ã§å‹æ•—åˆ¤å®šãŒã§ãã‚‹ã‹ã‚’ç¢ºã‹ã‚ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```dart
  void _tryToResolveArena(int pointer, _GestureArena state) {
    //...
    if (state.members.length == 1) {
      scheduleMicrotask(() => _resolveByDefault(pointer, state));
    } //...
  }
  
  void _resolveByDefault(int pointer, _GestureArena state) {
    //...
    _arenas.remove(pointer);
    assert(_debugLogDiagnostic(pointer, 'Default winner: ${state.members.first}'));
    state.members.first.acceptGesture(pointer);
  }
```

https://github.com/flutter/flutter/blob/7e9793dee1b85a243edd0e06cb1658e98b077561/packages/flutter/lib/src/gestures/arena.dart#L228

æœ€çµ‚çš„ã«ã¯ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ¡ãƒ³ãƒãƒ¼ã€ã¤ã¾ã‚Šæœ€å¾Œã¾ã§æ®‹ã£ãŸãƒ¡ãƒ³ãƒãƒ¼ãŒå‹åˆ©ã—ã¦ã„ã¾ã™ã­ã€‚

## å‹æ•—åˆ¤å®š3.èª°ã‚‚å‹åˆ©ã›ãšãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒé›¢ã‚ŒãŸå ´åˆ

![](https://storage.googleapis.com/zenn-user-upload/1a4d96e426be-20220319.jpg)

ä¸Šã§ã¯ãƒ¡ãƒ³ãƒãƒ¼ãŒèƒ½å‹•çš„ã«å‹åˆ©ãƒ»æ•—åŒ—å®£è¨€ã‚’è¡Œã†ã“ã¨ã§å‹è€…ãŒæ±ºå®šã—ã¾ã—ãŸã€‚å®£è¨€ã‚’è¡Œã‚ãªã„ã¾ã¾ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒé›¢ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã¯ã©ã®ã‚ˆã†ã«å‹è€…ãŒæ±ºã¾ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

pointerãŒé›¢ã‚ŒãŸã¨ãã€æœ€å¾Œã«é€ã‚‰ã‚Œã¦ãã‚‹ã®ã¯`PointerUpEvent`ã§ã™ã€‚ã“ã‚ŒãŒ`GestureBinding.handleEvent()`ã¾ã§åˆ°é”ã™ã‚‹ã¨ã€`GestureArenaManager.sweep()`ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

```dart
void handleEvent(PointerEvent event, HitTestEntry entry) {
  pointerRouter.route(event);
  if (event is PointerDownEvent) {
    gestureArena.close(event.pointer);
  } else if (event is PointerUpEvent) {
    gestureArena.sweep(event.pointer);
  } else if (event is PointerSignalEvent) {
    pointerSignalResolver.resolve(event);
  }
}
```

```dart
void sweep(int pointer) {
  final _GestureArena? state = _arenas[pointer];
  //...
  _arenas.remove(pointer);
  if (state.members.isNotEmpty) {
    // First member wins.
    assert(_debugLogDiagnostic(pointer, 'Winner: ${state.members.first}'));
    state.members.first.acceptGesture(pointer);
    // Give all the other members the bad news.
    for (int i = 1; i < state.members.length; i++)
      state.members[i].rejectGesture(pointer);
  }
}
```

https://api.flutter.dev/flutter/gestures/GestureArenaManager/sweep.html

ã¯ã„ã€å‰é …ã§æ•—åŒ—å®£è¨€ãŒè¡Œã‚ã‚ŒãŸå ´åˆã¨åŒæ§˜ã«ãƒªã‚¹ãƒˆã®æœ€åˆã®ãƒ¡ãƒ³ãƒãƒ¼ãŒå‹åˆ©ã¨ãªã‚Šã€ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯æ•—åŒ—é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

# 3.é—˜æŠ€å ´ã®é–‰å ´

![](https://storage.googleapis.com/zenn-user-upload/15e53dc72820-20220319.jpg)

é—˜æŠ€å ´å†…ã§å‹è€…ãŒæ±ºå®šã•ã‚Œã‚‹ã¨ã€ãã®é—˜æŠ€å ´ã¯`GestureArenaManager.remove()`ã§å‰Šé™¤ã•ã‚Œã¾ã™(å…ˆç¨‹ã‹ã‚‰ã¡ã‚‰ã»ã‚‰ã‚³ãƒ¼ãƒ‰å†…ã«å‡ºã¦ãã¦ã„ã‚‹)ã€‚
ä¸€æ–¹`PointerRouter`ã®æ–¹ã¯é—˜æŠ€å ´ã¨åŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‰Šé™¤ã•ã‚Œã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯é—˜æŠ€å ´ã§ã®å‹åˆ©å¾Œã‚‚`onDragEnd()`ãªã©ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«pointerã‚’å–å¾—ã—ãŸã„ã‹ã‚‰ã§ã™ã€‚ã“ã¡ã‚‰ã¯`PointerUpEvent`ãŒå‡¦ç†ã•ã‚ŒãŸã®ã¡ã«å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

# çµ‚ã‚ã‚Š

æ™®æ®µã‹ã‚‰ä½•æ°—ãªãä½¿ã£ã¦ã„ã‚‹Flutterã‚¢ãƒ—ãƒªã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã€‚è£å´ã§ã¯æ±ºé—˜è€…ãŸã¡ãŒç†±ãæˆ¦ã„ã‚’ç¹°ã‚Šåºƒã’ã¦ã„ãŸã®ã§ã—ãŸã€‚å½¼ã‚‰ã¨å¿ƒã‚’é€šã‚ã›ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®æŒ™å‹•ã«æƒ‘ã‚ã•ã‚Œã‚‹ã“ã¨ã‚‚æ¸›ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚